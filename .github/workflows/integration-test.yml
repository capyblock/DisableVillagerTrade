name: Integration Tests

on:
  workflow_dispatch:  # Manual trigger
  pull_request:
    branches: [develop, master]

env:
  JAVA_VERSION: '21'

jobs:
  check-changes:
    name: Check for Code Changes
    runs-on: ubuntu-latest
    outputs:
      should_test: ${{ steps.changes.outputs.should_test }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check for code file changes
        id: changes
        run: |
          COMMIT_MSG="${{ github.event.pull_request.title || github.event.head_commit.message }}"
          
          # Check for skip ci first - highest priority to skip
          if [[ "$COMMIT_MSG" == *"[skip ci]"* ]] || [[ "$COMMIT_MSG" == *"[ci skip]"* ]]; then
            echo "‚è≠Ô∏è Skipping due to [skip ci]"
            echo "should_test=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for force deploy - bypasses file change detection
          if [[ "$COMMIT_MSG" == *"[force deploy]"* ]]; then
            echo "‚úÖ Force deploy requested"
            echo "should_test=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Manual trigger always runs
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "‚úÖ Manual trigger"
            echo "should_test=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # No overrides, check for actual file changes
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          SHOULD_TEST="false"
          
          while IFS= read -r file; do
            if [[ "$file" == */src/main/* ]] || \
               [[ "$file" == **/build.gradle.kts ]]; then
              SHOULD_TEST="true"
              echo "‚úÖ Code file changed: $file"
              break
            fi
          done <<< "$CHANGED_FILES"
          
          echo "should_test=$SHOULD_TEST" >> $GITHUB_OUTPUT
          echo "Should test: $SHOULD_TEST"

  # Build everything once
  build:
    name: üî® Build All Platforms
    needs: check-changes
    if: needs.check-changes.outputs.should_test == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle
      
      - name: Build all platforms
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon
      
      - name: Upload Bukkit artifact
        uses: actions/upload-artifact@v5
        with:
          name: bukkit-jar
          path: bukkit/build/libs/*.jar
          retention-days: 1
      
      - name: Upload Fabric artifact
        uses: actions/upload-artifact@v5
        with:
          name: fabric-jar
          path: fabric/build/libs/*.jar
          retention-days: 1
      
      - name: Upload Forge artifact
        uses: actions/upload-artifact@v5
        with:
          name: forge-jar
          path: forge/build/libs/*.jar
          retention-days: 1
      
      - name: Upload NeoForge artifact
        uses: actions/upload-artifact@v5
        with:
          name: neoforge-jar
          path: neoforge/build/libs/*.jar
          retention-days: 1

  test-bukkit:
    name: ü™£ Test Bukkit/Paper
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Download Bukkit artifact
        uses: actions/download-artifact@v6
        with:
          name: bukkit-jar
          path: bukkit-build
      
      - name: Download Paper server
        run: |
          mkdir -p test-server/plugins
          
          MC_VERSION=$(grep "^minecraftVersion=" gradle.properties | cut -d'=' -f2 | tr -d '\r\n')
          echo "Building for Minecraft $MC_VERSION"
          
          PAPER_BUILD=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/${MC_VERSION}/builds" 2>/dev/null | jq -r '.builds[-1].build' 2>/dev/null)
          
          if [ -z "$PAPER_BUILD" ] || [ "$PAPER_BUILD" = "null" ]; then
            echo "Paper $MC_VERSION not available, using latest stable version"
            MC_VERSION=$(curl -s "https://api.papermc.io/v2/projects/paper" | jq -r '.versions[-1]')
            PAPER_BUILD=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/${MC_VERSION}/builds" | jq -r '.builds[-1].build')
          fi
          
          echo "Using Paper $MC_VERSION build $PAPER_BUILD"
          curl -o test-server/paper.jar \
            "https://api.papermc.io/v2/projects/paper/versions/${MC_VERSION}/builds/${PAPER_BUILD}/downloads/paper-${MC_VERSION}-${PAPER_BUILD}.jar"
          
          find bukkit-build -name "*.jar" ! -name "*-slim.jar" -exec cp {} test-server/plugins/ \;
          echo "eula=true" > test-server/eula.txt
          echo -e "online-mode=false\nspawn-protection=0\nmax-tick-time=-1" > test-server/server.properties
      
      - name: Start Paper server and test plugin
        timeout-minutes: 5
        run: |
          cd test-server
          java -Xmx1G -jar paper.jar --nogui &
          SERVER_PID=$!
          
          echo "‚è≥ Waiting for server to start..."
          
          for i in {1..120}; do
            if grep -q "Done" logs/latest.log 2>/dev/null; then
              echo "‚úÖ Server started successfully!"
              break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "‚ùå Server crashed!"; cat logs/latest.log 2>/dev/null; exit 1
            fi
            sleep 1
          done
          
          if grep -qi "DisableVillagerTrade" logs/latest.log; then
            echo "‚úÖ Plugin loaded!"
          else
            echo "‚ùå Plugin failed to load!"; cat logs/latest.log; exit 1
          fi
          
          if grep -qiE "(ERROR|SEVERE).*DisableVillagerTrade" logs/latest.log; then
            echo "‚ùå Plugin has errors!"; exit 1
          fi
          
          kill $SERVER_PID 2>/dev/null || true
          echo "‚úÖ Bukkit integration test passed!"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: paper-server-logs
          path: test-server/logs/

  test-fabric:
    name: üßµ Test Fabric
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Download Fabric artifact
        uses: actions/download-artifact@v6
        with:
          name: fabric-jar
          path: fabric-build
      
      - name: Download Fabric server
        run: |
          mkdir -p test-server/mods
          
          MC_VERSION=$(grep "^minecraftVersion=" gradle.properties | cut -d'=' -f2 | tr -d '\r\n')
          echo "Building for Minecraft $MC_VERSION"
          
          curl -o fabric-installer.jar "https://maven.fabricmc.net/net/fabricmc/fabric-installer/1.0.1/fabric-installer-1.0.1.jar"
          java -jar fabric-installer.jar server -mcversion $MC_VERSION -dir test-server -downloadMinecraft
          
          FABRIC_API_URL=$(curl -s "https://api.modrinth.com/v2/project/fabric-api/version?game_versions=%5B%22${MC_VERSION}%22%5D&loaders=%5B%22fabric%22%5D" | jq -r '.[0].files[0].url')
          if [ -n "$FABRIC_API_URL" ] && [ "$FABRIC_API_URL" != "null" ]; then
            curl -L -o test-server/mods/fabric-api.jar "$FABRIC_API_URL"
          fi
          
          find fabric-build -name "*.jar" ! -name "*-dev.jar" ! -name "*-sources.jar" -exec cp {} test-server/mods/ \;
          echo "eula=true" > test-server/eula.txt
          echo -e "online-mode=false\nspawn-protection=0\nmax-tick-time=-1" > test-server/server.properties
      
      - name: Start Fabric server and test mod
        timeout-minutes: 5
        run: |
          cd test-server
          java -Xmx1G -jar fabric-server-launch.jar --nogui &
          SERVER_PID=$!
          
          echo "‚è≥ Waiting for Fabric server to start..."
          
          for i in {1..120}; do
            if grep -q "Done" logs/latest.log 2>/dev/null; then
              echo "‚úÖ Server started!"; break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "‚ùå Server crashed!"; cat logs/latest.log 2>/dev/null; exit 1
            fi
            sleep 1
          done
          
          if grep -qiE "(ERROR|FATAL).*disablevillagertrade" logs/latest.log; then
            echo "‚ùå Mod has errors!"; exit 1
          fi
          
          kill $SERVER_PID 2>/dev/null || true
          echo "‚úÖ Fabric integration test passed!"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: fabric-server-logs
          path: test-server/logs/

  test-forge:
    name: üî• Test Forge
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Download Forge artifact
        uses: actions/download-artifact@v6
        with:
          name: forge-jar
          path: forge-build
      
      - name: Download Forge server
        run: |
          mkdir -p test-server/mods
          FORGE_VERSION=$(grep "^forgeVersion=" gradle.properties | cut -d'=' -f2 | tr -d '\r\n')
          echo "Using Forge version: $FORGE_VERSION"
          
          FORGE_URL="https://maven.minecraftforge.net/net/minecraftforge/forge/${FORGE_VERSION}/forge-${FORGE_VERSION}-installer.jar"
          echo "Downloading from: $FORGE_URL"
          curl -f -o forge-installer.jar "$FORGE_URL"
          java -jar forge-installer.jar --installServer test-server
          
          find forge-build -name "*.jar" ! -name "*-sources.jar" ! -name "*-slim.jar" -exec cp {} test-server/mods/ \;
          echo "eula=true" > test-server/eula.txt
          echo -e "online-mode=false\nspawn-protection=0\nmax-tick-time=-1" > test-server/server.properties
      
      - name: Start Forge server and test mod
        timeout-minutes: 8
        run: |
          cd test-server
          
          if [ -f "run.sh" ]; then
            chmod +x run.sh && ./run.sh --nogui &
          else
            FORGE_JAR=$(find . -maxdepth 1 -name "forge-*.jar" ! -name "*installer*" | head -1)
            if [ -n "$FORGE_JAR" ]; then
              java -Xmx2G -jar "$FORGE_JAR" --nogui &
            else
              java -Xmx2G @user_jvm_args.txt @libraries/net/minecraftforge/forge/*/unix_args.txt --nogui &
            fi
          fi
          SERVER_PID=$!
          
          echo "‚è≥ Waiting for Forge server to start..."
          
          for i in {1..150}; do
            if grep -q "Done" logs/latest.log 2>/dev/null; then
              echo "‚úÖ Server started!"; break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "‚ùå Server crashed!"; cat logs/latest.log 2>/dev/null; exit 1
            fi
            sleep 1
          done
          
          if grep -qiE "(ERROR|FATAL).*disablevillagertrade" logs/latest.log 2>/dev/null; then
            echo "‚ùå Mod has errors!"; exit 1
          fi
          
          kill $SERVER_PID 2>/dev/null || true
          echo "‚úÖ Forge integration test passed!"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: forge-server-logs
          path: test-server/logs/

  test-neoforge:
    name: ‚öíÔ∏è Test NeoForge
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Download NeoForge artifact
        uses: actions/download-artifact@v6
        with:
          name: neoforge-jar
          path: neoforge-build
      
      - name: Download NeoForge server
        run: |
          mkdir -p test-server/mods
          NEOFORGE_VERSION=$(grep "^neoforgeVersion=" gradle.properties | cut -d'=' -f2 | tr -d '\r\n')
          echo "Using NeoForge version: $NEOFORGE_VERSION"
          
          NEOFORGE_URL="https://maven.neoforged.net/releases/net/neoforged/neoforge/${NEOFORGE_VERSION}/neoforge-${NEOFORGE_VERSION}-installer.jar"
          echo "Downloading from: $NEOFORGE_URL"
          curl -f -o neoforge-installer.jar "$NEOFORGE_URL"
          java -jar neoforge-installer.jar --installServer test-server
          
          find neoforge-build -name "*.jar" ! -name "*-sources.jar" ! -name "*-slim.jar" -exec cp {} test-server/mods/ \;
          echo "eula=true" > test-server/eula.txt
          echo -e "online-mode=false\nspawn-protection=0\nmax-tick-time=-1" > test-server/server.properties
      
      - name: Start NeoForge server and test mod
        timeout-minutes: 8
        run: |
          cd test-server
          
          if [ -f "run.sh" ]; then
            chmod +x run.sh && ./run.sh --nogui &
          else
            java -Xmx2G @user_jvm_args.txt @libraries/net/neoforged/neoforge/*/unix_args.txt --nogui &
          fi
          SERVER_PID=$!
          
          echo "‚è≥ Waiting for NeoForge server to start..."
          
          for i in {1..180}; do
            if grep -q "Done" logs/latest.log 2>/dev/null; then
              echo "‚úÖ Server started!"; break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "‚ùå Server crashed!"; cat logs/latest.log 2>/dev/null; exit 1
            fi
            sleep 1
          done
          
          if grep -qiE "(ERROR|FATAL).*disablevillagertrade" logs/latest.log 2>/dev/null; then
            echo "‚ùå Mod has errors!"; exit 1
          fi
          
          kill $SERVER_PID 2>/dev/null || true
          echo "‚úÖ NeoForge integration test passed!"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: neoforge-server-logs
          path: test-server/logs/

  # Summary job
  integration-summary:
    name: üìä Integration Test Summary
    needs: [check-changes, test-bukkit, test-fabric, test-forge, test-neoforge]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Handle skipped case
          if [ "${{ needs.check-changes.outputs.should_test }}" != "true" ]; then
            echo "‚è≠Ô∏è Integration tests skipped - no relevant code changes" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          if [ "${{ needs.test-bukkit.result }}" == "success" ]; then
            echo "‚úÖ **Bukkit/Paper**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Bukkit/Paper**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-fabric.result }}" == "success" ]; then
            echo "‚úÖ **Fabric**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Fabric**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-forge.result }}" == "success" ]; then
            echo "‚úÖ **Forge**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Forge**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-neoforge.result }}" == "success" ]; then
            echo "‚úÖ **NeoForge**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **NeoForge**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-bukkit.result }}" != "success" ] || \
             [ "${{ needs.test-fabric.result }}" != "success" ] || \
             [ "${{ needs.test-forge.result }}" != "success" ] || \
             [ "${{ needs.test-neoforge.result }}" != "success" ]; then
            echo ""
            echo "‚ùå Some integration tests failed!"
            exit 1
          fi
          
          echo ""
          echo "üéâ All integration tests passed!"
