name: Integration Tests

on:
  workflow_dispatch:  # Manual trigger
  pull_request:
    branches: [develop, master]
    paths:
      - '*/src/main/**'
      - '**/build.gradle.kts'

env:
  JAVA_VERSION: '21'

jobs:
  # Build everything once
  build:
    name: ğŸ”¨ Build All Platforms
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle
      
      - name: Build all platforms
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon
      
      - name: Upload Bukkit artifact
        uses: actions/upload-artifact@v5
        with:
          name: bukkit-jar
          path: bukkit/build/libs/*.jar
          retention-days: 1
      
      - name: Upload Fabric artifact
        uses: actions/upload-artifact@v5
        with:
          name: fabric-jar
          path: fabric/build/libs/*.jar
          retention-days: 1
      
      - name: Upload Forge artifact
        uses: actions/upload-artifact@v5
        with:
          name: forge-jar
          path: forge/build/libs/*.jar
          retention-days: 1
      
      - name: Upload NeoForge artifact
        uses: actions/upload-artifact@v5
        with:
          name: neoforge-jar
          path: neoforge/build/libs/*.jar
          retention-days: 1

  test-bukkit:
    name: ğŸª£ Test Bukkit/Paper
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Download Bukkit artifact
        uses: actions/download-artifact@v4
        with:
          name: bukkit-jar
          path: bukkit-build
      
      - name: Download Paper server
        run: |
          mkdir -p test-server/plugins
          
          MC_VERSION=$(grep "^minecraftVersion=" gradle.properties | cut -d'=' -f2 | tr -d '\r\n')
          echo "Building for Minecraft $MC_VERSION"
          
          PAPER_BUILD=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/${MC_VERSION}/builds" 2>/dev/null | jq -r '.builds[-1].build' 2>/dev/null)
          
          if [ -z "$PAPER_BUILD" ] || [ "$PAPER_BUILD" = "null" ]; then
            echo "Paper $MC_VERSION not available, using latest stable version"
            MC_VERSION=$(curl -s "https://api.papermc.io/v2/projects/paper" | jq -r '.versions[-1]')
            PAPER_BUILD=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/${MC_VERSION}/builds" | jq -r '.builds[-1].build')
          fi
          
          echo "Using Paper $MC_VERSION build $PAPER_BUILD"
          curl -o test-server/paper.jar \
            "https://api.papermc.io/v2/projects/paper/versions/${MC_VERSION}/builds/${PAPER_BUILD}/downloads/paper-${MC_VERSION}-${PAPER_BUILD}.jar"
          
          find bukkit-build -name "*.jar" ! -name "*-slim.jar" -exec cp {} test-server/plugins/ \;
          echo "eula=true" > test-server/eula.txt
          echo -e "online-mode=false\nspawn-protection=0\nmax-tick-time=-1" > test-server/server.properties
      
      - name: Start Paper server and test plugin
        timeout-minutes: 5
        run: |
          cd test-server
          java -Xmx1G -jar paper.jar --nogui &
          SERVER_PID=$!
          
          echo "â³ Waiting for server to start..."
          
          for i in {1..120}; do
            if grep -q "Done" logs/latest.log 2>/dev/null; then
              echo "âœ… Server started successfully!"
              break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "âŒ Server crashed!"; cat logs/latest.log 2>/dev/null; exit 1
            fi
            sleep 1
          done
          
          if grep -qi "DisableVillagerTrade" logs/latest.log; then
            echo "âœ… Plugin loaded!"
          else
            echo "âŒ Plugin failed to load!"; cat logs/latest.log; exit 1
          fi
          
          if grep -qiE "(ERROR|SEVERE).*DisableVillagerTrade" logs/latest.log; then
            echo "âŒ Plugin has errors!"; exit 1
          fi
          
          kill $SERVER_PID 2>/dev/null || true
          echo "âœ… Bukkit integration test passed!"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: paper-server-logs
          path: test-server/logs/

  test-fabric:
    name: ğŸ§µ Test Fabric
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Download Fabric artifact
        uses: actions/download-artifact@v4
        with:
          name: fabric-jar
          path: fabric-build
      
      - name: Download Fabric server
        run: |
          mkdir -p test-server/mods
          
          MC_VERSION=$(grep "^minecraftVersion=" gradle.properties | cut -d'=' -f2 | tr -d '\r\n')
          echo "Building for Minecraft $MC_VERSION"
          
          curl -o fabric-installer.jar "https://maven.fabricmc.net/net/fabricmc/fabric-installer/1.0.1/fabric-installer-1.0.1.jar"
          java -jar fabric-installer.jar server -mcversion $MC_VERSION -dir test-server -downloadMinecraft
          
          FABRIC_API_URL=$(curl -s "https://api.modrinth.com/v2/project/fabric-api/version?game_versions=%5B%22${MC_VERSION}%22%5D&loaders=%5B%22fabric%22%5D" | jq -r '.[0].files[0].url')
          if [ -n "$FABRIC_API_URL" ] && [ "$FABRIC_API_URL" != "null" ]; then
            curl -L -o test-server/mods/fabric-api.jar "$FABRIC_API_URL"
          fi
          
          find fabric-build -name "*.jar" ! -name "*-dev.jar" ! -name "*-sources.jar" -exec cp {} test-server/mods/ \;
          echo "eula=true" > test-server/eula.txt
          echo -e "online-mode=false\nspawn-protection=0\nmax-tick-time=-1" > test-server/server.properties
      
      - name: Start Fabric server and test mod
        timeout-minutes: 5
        run: |
          cd test-server
          java -Xmx1G -jar fabric-server-launch.jar --nogui &
          SERVER_PID=$!
          
          echo "â³ Waiting for Fabric server to start..."
          
          for i in {1..120}; do
            if grep -q "Done" logs/latest.log 2>/dev/null; then
              echo "âœ… Server started!"; break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "âŒ Server crashed!"; cat logs/latest.log 2>/dev/null; exit 1
            fi
            sleep 1
          done
          
          if grep -qiE "(ERROR|FATAL).*disablevillagertrade" logs/latest.log; then
            echo "âŒ Mod has errors!"; exit 1
          fi
          
          kill $SERVER_PID 2>/dev/null || true
          echo "âœ… Fabric integration test passed!"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: fabric-server-logs
          path: test-server/logs/

  test-forge:
    name: ğŸ”¥ Test Forge
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Download Forge artifact
        uses: actions/download-artifact@v4
        with:
          name: forge-jar
          path: forge-build
      
      - name: Download Forge server
        run: |
          mkdir -p test-server/mods
          FORGE_VERSION=$(grep "^forgeVersion=" gradle.properties | cut -d'=' -f2 | tr -d '\r\n')
          echo "Using Forge version: $FORGE_VERSION"
          
          FORGE_URL="https://maven.minecraftforge.net/net/minecraftforge/forge/${FORGE_VERSION}/forge-${FORGE_VERSION}-installer.jar"
          echo "Downloading from: $FORGE_URL"
          curl -f -o forge-installer.jar "$FORGE_URL"
          java -jar forge-installer.jar --installServer test-server
          
          find forge-build -name "*.jar" ! -name "*-sources.jar" ! -name "*-slim.jar" -exec cp {} test-server/mods/ \;
          echo "eula=true" > test-server/eula.txt
          echo -e "online-mode=false\nspawn-protection=0\nmax-tick-time=-1" > test-server/server.properties
      
      - name: Start Forge server and test mod
        timeout-minutes: 8
        run: |
          cd test-server
          
          if [ -f "run.sh" ]; then
            chmod +x run.sh && ./run.sh --nogui &
          else
            FORGE_JAR=$(find . -maxdepth 1 -name "forge-*.jar" ! -name "*installer*" | head -1)
            if [ -n "$FORGE_JAR" ]; then
              java -Xmx2G -jar "$FORGE_JAR" --nogui &
            else
              java -Xmx2G @user_jvm_args.txt @libraries/net/minecraftforge/forge/*/unix_args.txt --nogui &
            fi
          fi
          SERVER_PID=$!
          
          echo "â³ Waiting for Forge server to start..."
          
          for i in {1..150}; do
            if grep -q "Done" logs/latest.log 2>/dev/null; then
              echo "âœ… Server started!"; break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "âŒ Server crashed!"; cat logs/latest.log 2>/dev/null; exit 1
            fi
            sleep 1
          done
          
          if grep -qiE "(ERROR|FATAL).*disablevillagertrade" logs/latest.log 2>/dev/null; then
            echo "âŒ Mod has errors!"; exit 1
          fi
          
          kill $SERVER_PID 2>/dev/null || true
          echo "âœ… Forge integration test passed!"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: forge-server-logs
          path: test-server/logs/

  test-neoforge:
    name: âš’ï¸ Test NeoForge
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Download NeoForge artifact
        uses: actions/download-artifact@v4
        with:
          name: neoforge-jar
          path: neoforge-build
      
      - name: Download NeoForge server
        run: |
          mkdir -p test-server/mods
          NEOFORGE_VERSION=$(grep "^neoforgeVersion=" gradle.properties | cut -d'=' -f2 | tr -d '\r\n')
          echo "Using NeoForge version: $NEOFORGE_VERSION"
          
          NEOFORGE_URL="https://maven.neoforged.net/releases/net/neoforged/neoforge/${NEOFORGE_VERSION}/neoforge-${NEOFORGE_VERSION}-installer.jar"
          echo "Downloading from: $NEOFORGE_URL"
          curl -f -o neoforge-installer.jar "$NEOFORGE_URL"
          java -jar neoforge-installer.jar --installServer test-server
          
          find neoforge-build -name "*.jar" ! -name "*-sources.jar" ! -name "*-slim.jar" -exec cp {} test-server/mods/ \;
          echo "eula=true" > test-server/eula.txt
          echo -e "online-mode=false\nspawn-protection=0\nmax-tick-time=-1" > test-server/server.properties
      
      - name: Start NeoForge server and test mod
        timeout-minutes: 8
        run: |
          cd test-server
          
          if [ -f "run.sh" ]; then
            chmod +x run.sh && ./run.sh --nogui &
          else
            java -Xmx2G @user_jvm_args.txt @libraries/net/neoforged/neoforge/*/unix_args.txt --nogui &
          fi
          SERVER_PID=$!
          
          echo "â³ Waiting for NeoForge server to start..."
          
          for i in {1..180}; do
            if grep -q "Done" logs/latest.log 2>/dev/null; then
              echo "âœ… Server started!"; break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "âŒ Server crashed!"; cat logs/latest.log 2>/dev/null; exit 1
            fi
            sleep 1
          done
          
          if grep -qiE "(ERROR|FATAL).*disablevillagertrade" logs/latest.log 2>/dev/null; then
            echo "âŒ Mod has errors!"; exit 1
          fi
          
          kill $SERVER_PID 2>/dev/null || true
          echo "âœ… NeoForge integration test passed!"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: neoforge-server-logs
          path: test-server/logs/

  # Summary job
  integration-summary:
    name: ğŸ“Š Integration Test Summary
    needs: [test-bukkit, test-fabric, test-forge, test-neoforge]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-bukkit.result }}" == "success" ]; then
            echo "âœ… **Bukkit/Paper**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Bukkit/Paper**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-fabric.result }}" == "success" ]; then
            echo "âœ… **Fabric**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Fabric**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-forge.result }}" == "success" ]; then
            echo "âœ… **Forge**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Forge**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-neoforge.result }}" == "success" ]; then
            echo "âœ… **NeoForge**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **NeoForge**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-bukkit.result }}" != "success" ] || \
             [ "${{ needs.test-fabric.result }}" != "success" ] || \
             [ "${{ needs.test-forge.result }}" != "success" ] || \
             [ "${{ needs.test-neoforge.result }}" != "success" ]; then
            echo ""
            echo "âŒ Some integration tests failed!"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ All integration tests passed!"
